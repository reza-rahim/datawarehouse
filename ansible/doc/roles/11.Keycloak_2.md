
# **Keycloak PostgreSQL Logical Replication and Service Setup with Ansible**

## **Overview**
This technical documentation outlines the use of Ansible to automate the setup of **logical replication** between two PostgreSQL nodes for the `keycloak` database and configure systemd services for running Keycloak.

---

## **1. Check for Existing Tables**
### **Task: Check if Tables Exist in `keycloak`**
- **Purpose**: Avoid re-importing schema if tables already exist.
- **Action**: Executes a SQL query to count tables in the `public` schema.
```yaml
- name: Check if any tables exist in the database keycloak
```

---

## **2. Initial Database Copy**
### **Task: Direct Copy from Source to Target**
- **Purpose**: Sync data between source (`node1`) and target (`node2`) before replication.
- **Method**: Uses `pg_dump` and `psql` to copy the schema and data.
- **Condition**: Runs only if no tables exist in target DB.
```yaml
- name: Direct copy from source to target PostgreSQL database
```

---

## **3. Create Publications**
### **Task: Create Logical Replication Publications**
- **Purpose**: Enable replication of all tables from both nodes.
- **Command**: `CREATE PUBLICATION pub_keycloak_x FOR ALL TABLES;`
- **Note**: Errors are ignored (to allow re-runs).
```yaml
- name:  create PUBLICATION
```

---

## **4. Create Subscriptions**
### **Task: Create Mutual Subscriptions**
- **Purpose**: Enable bidirectional replication by subscribing to the counterpart's publication.
- **Option**: `origin = 'none'` disables conflict resolution priority.
```yaml
- name: Create SUBSCRIPTION sub_keycloak_1 and sub_keycloak_2
```

---

## **[Repeat Block] Re-check & Redo Setup**
> A second full repeat of the above steps is present. This could serve as a fallback redundancy or can be refactored into a loop or separate role for efficiency.

---

## **5. Deploy Keycloak Configuration**
### **Task: Copy Keycloak Configuration Files**
- **Files**:
  - `keycloak.conf.j2` → Keycloak server config
  - `run-keycloak.sh.j2` → Startup script
  - `keycloak.service.j2` → systemd service definition
- **Permissions**:
  - Executable for scripts
  - Read access for config
- **Handler Triggered**: `restart start_keycloak`
```yaml
- name: copy keycloak.conf file
```

---

## **6. Reload systemd Daemon**
### **Task: Reload service files**
- **Purpose**: Ensure the newly added `keycloak.service` is recognized.
```yaml
- name: Reload service files
```

---

## **7. Execute Handlers Immediately**
### **Task: Flush the Handlers**
- **Purpose**: Ensure all pending notifications (e.g., service restarts) are handled immediately.
```yaml
- name: flush the handeler
```

---

## **Variables Expected**
- `db_user`: PostgreSQL superuser or admin used for DB operations.
- `db_password`: Password for the `db_user`.
- `keycloak_home`: Target directory for Keycloak.
- `hostvars['node1']` / `hostvars['node2']`: Host definitions for PostgreSQL source/target.
