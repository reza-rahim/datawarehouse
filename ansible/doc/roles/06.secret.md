
# Secure Environment Variable Management with Ansible

This document outlines the Ansible automation used to securely manage and encrypt application environment variables. The playbook ensures secure storage of credentials and secrets using GPG encryption and controlled access.

---

## Overview

The automation performs the following key actions:

1. **Creates a secure directory** to store encrypted secrets.
2. **Deploys a decryption script** for later access to the environment variables.
3. **Encrypts environment variables** from predefined system environment values and stores them in a GPG-encrypted file.

---

## Tasks Breakdown

### 1. Create Secret Directory

Creates the directory that will contain the encrypted secret file.

```yaml
- name: create {{ secret_dir }} dir
  file:
    path: '{{ secret_dir }}'
    state: directory
    group: '{{ application_group }}'
    mode: '0750'
```

- **Purpose**: Ensure a secure location exists.
- **Permissions**: Read, write, and execute for owner; read and execute for group.

---

### 2. Deploy Decryption Script

Copies a templated script used to decrypt the secrets on the target system.

```yaml
- name: copy decrypt_secret_eval.sh to {{ secret_dir }}
  template:
    src: '{{ item.src }}'
    dest: '{{ item.dest }}'
    group: '{{ application_group }}'
    mode: '0650'
  loop:
    - { src: 'decrypt_secret_eval.sh.j2', dest: '{{ secret_dir }}/decrypt_secret_eval.sh' }
```

- **Purpose**: Allows safe retrieval of secrets at runtime.
- **Permissions**: Executable by owner; readable by group.

---

### 3. Encrypt Environment Variables

Creates a GPG-encrypted file containing all required environment variables for the application.

```yaml
- name: create {{ secret_dir }}/{{ secret_file }}
  shell: |
    env_vars=$(cat <<EOF
    export PGUSER={{ lookup('env', 'PGUSER') }}
    export PGPASSWORD={{ lookup('env', 'PGPASSWORD') }}
    ...
    export SPARK_UI_PASSWORD={{ lookup('env', 'SPARK_UI_PASSWORD') }}
    EOF
    )
    
    echo "$env_vars" | gpg --batch --quiet --yes --passphrase "$({{ passphrase }})" -c > {{ secret_dir }}/{{ secret_file }}
    chmod 0750 {{ secret_dir }}/{{ secret_file }}
    chgrp {{ application_group }} {{ secret_dir }}/{{ secret_file }}
```

- **Purpose**: Store secrets in encrypted form using GPG and a system-derived passphrase (e.g., from `/etc/machine-id`).
- **Security**: Only accessible to the designated group and user.

---

## Usage Notes

- Ensure all required environment variables are present on the target system before execution.
- The decryption script (`decrypt_secret_eval.sh`) should be sourced or run before starting any dependent services.
- The passphrase used for GPG encryption should be derived securely, typically using `$(cat /etc/machine-id)` or another trusted source.

---

## Security Considerations

- Use restrictive permissions (`0750`, `0650`) for files and directories.
- Avoid hardcoding secrets in playbooks; rely on environment variables or vaults.
- Use group-based access control (`{{ application_group }}`) to limit exposure.

---

## Conclusion

This Ansible-based approach provides a structured, repeatable, and secure method to manage application secrets. By leveraging GPG encryption and templating, it enables secure runtime access while minimizing risk of credential leaks.

