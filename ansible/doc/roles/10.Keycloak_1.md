
# **Keycloak Installation and Configuration via Ansible**

## **Overview**
This document describes the automated process for installing and configuring **Keycloak** using Ansible. It includes downloading a ZIP package from a remote repository, setting up directory structure and symbolic links, copying configuration files, and enabling systemd service for Keycloak.

---

## **1. Check for Existing Installation**
### **Task: Check that the `{{ keycloak_home }}` Exists**
- **Purpose**: Prevent reinstallation if Keycloak is already deployed.
- **Action**: Uses the `stat` module to check if the symbolic link or directory defined by `keycloak_home` exists.
```yaml
- name: Check that the {{ keycloak_home }} exists
```

---

## **2. Extract Keycloak ZIP Package**
### **Task: Extract Keycloak ZIP**
- **Purpose**: Download and extract the Keycloak archive only if not already installed.
- **Details**:
  - Downloads from a remote repository hosted on the `repo` group host.
  - Extracts to `/opt` with proper ownership.
  - Skipped if `keycloak_home` already exists.
- **Triggers**: `build keycloak` handler.
```yaml
- name : extract keycloak zip
```

---

## **3. Create Symbolic Link**
### **Task: Create Soft Link to `{{ keycloak_home }}`**
- **Purpose**: Establish a consistent symbolic link to the extracted Keycloak directory.
- **Details**:
  - The link points from `keycloak_home` to the actual directory `/opt/{{ keycloak_file_name }}`.
- **Condition**: Runs only if Keycloak is not already installed.
```yaml
- name: create soft link to {{ keycloak_home }}
```

---

## **4. Configure Keycloak**
### **Task: Copy Keycloak Configuration Files**
- **Purpose**: Deploy service and runtime configuration for Keycloak.
- **Files Copied**:
  - `keycloak.conf.j2` → `{{ keycloak_home }}/conf/keycloak.conf`
  - `run-keycloak.sh.j2` → `{{ keycloak_home }}/run-keycloak.sh`
  - `keycloak.service.j2` → `/etc/systemd/system/keycloak.service`
- **Permissions**:
  - Script (`run-keycloak.sh`) is executable.
  - Configuration and service unit files have read access.
- **Triggers**: `restart start_keycloak` handler.
```yaml
- name: copy keycloak.conf file
```

---

## **5. Reload systemd**
### **Task: Reload service files**
- **Purpose**: Ensures systemd detects the new Keycloak service unit.
```yaml
- name: Reload service files
```

---

## **6. Execute All Handlers Immediately**
### **Task: Flush the Handler**
- **Purpose**: Forces execution of notified handlers (e.g., build or restart Keycloak) immediately after configuration changes.
```yaml
- name: flush the handeler
```

---

## **Variables Expected**
- `keycloak_home`: Path where Keycloak should be accessible via symlink.
- `keycloak_url_file_name`: The name of the ZIP file on the remote server.
- `keycloak_file_name`: The extracted directory name.
- `keycloak_user`: Linux user who owns Keycloak.
- `application_group`: Group under which Keycloak runs.
