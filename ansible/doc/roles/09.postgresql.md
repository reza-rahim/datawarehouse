
# **PostgreSQL 16 Setup with SSL and App Database Initialization via Ansible**

## **Overview**
This document outlines the steps performed by an Ansible playbook to set up a PostgreSQL 16 instance with SSL support, remote access configuration, and initial database creation for multiple applications (Keycloak, Hive, and Airflow). Optional schema initialization tasks are included but currently disabled.

---

## **Tasks Summary**

### **1. Prepare Environment**
#### **Add `postgres` User to SSL Group**
Allows PostgreSQL to access SSL certificates.
```yaml
- name: Add postgres user to ssl-cert group (required for SSL access)
```

### **2. Configure PostgreSQL APT Repository**
#### **Import PostgreSQL GPG Key**
Downloads and imports the GPG key required to verify PostgreSQL packages.
```yaml
- name: Add PostgreSQL APT key
- name: Import PostgreSQL key
```

#### **Add Official PostgreSQL APT Repo**
Adds PostgreSQLâ€™s official repository for the current Debian-based system.
```yaml
- name: Add PostgreSQL APT repository
```

#### **Update APT Cache**
Ensures the package list includes newly added repositories.
```yaml
- name: Update apt cache
```

### **3. Install and Configure PostgreSQL**
#### **Install PostgreSQL Server and Client**
Installs the specific version of PostgreSQL along with the client.
```yaml
- name: Install postgresql
```

#### **Enable and Start PostgreSQL Service**
Ensures the PostgreSQL 16 service is running and enabled at boot.
```yaml
- name: Ensure PostgreSQL 16 service is enabled and started
```

#### **Wait for PostgreSQL to Accept Connections**
Ensures the PostgreSQL service is fully initialized before proceeding.
```yaml
- name: Wait for PostgreSQL to be ready
```

### **4. PostgreSQL Initial Setup**
#### **Create Superuser**
Creates a default `postgres` user with the provided password.
```yaml
- name: Create db user
```

#### **Configure Remote Access**
Applies custom `postgresql.conf` and `pg_hba.conf` from templates.
```yaml
- name: Allow remote access - postgresql.conf
- name: Allow remote access - pg_hba.conf
```

### **5. Create Application Databases**
Creates databases for various applications.
```yaml
- name: Create hive database
- name: Create keycloak database
- name: Create airflow database
```

#### **Optional: Grant Access to Application User**
(Currently disabled) Grants database privileges to a specific app user.
```yaml
- name: disabled (Grant db user access to app db)
```

---

---

## **Notes**
- Variables such as `pg_version`, `db_user`, `pg_conf_path`, `hive_db_name`, `keycloak_db_name`, and `airflow_db_name` are expected to be defined in your Ansible inventory or playbook.
- Schema initialization and access grants are optional and can be enabled by modifying the `when` conditions.
