- name: create {{ cert_dir }} dir
  file:
     path: '{{ cert_dir }}'
     state: directory
     group: '{{ application_group }}'

# Task 2: Copy the certificate files to the cert_dir directory.       
- name: copy  cert files
  template: src='{{ item.src }}' dest='{{ item.dest }}' group='{{ application_group }}'  mode=0640
  loop:
     - { src: '{{ server_cert_file_name }}', dest: '{{ cert_dir }}/{{ server_cert_file_name }}'  }
     - { src: '{{ server_key_file_name }}', dest: '{{ cert_dir }}/{{ server_key_file_name }}'  }
     - { src: '{{ server_cert_key_file_name }}', dest: '{{ cert_dir }}/{{ server_cert_key_file_name }}'  }

# Task 3: Create the directory for MinIO's certificates.       
- name: Create {{ cert_dir }} directory
  file:
    path: "{{ minio_home_cert }}"
    state: directory
    mode: '0750'
    owner: "{{ minio_user }}"
    group: "{{ minio_group }}"
       
# Task 4: Copy MinIO's certificate files to the minio_home_cert directory.       
- name: copy  cert files for minio
  template: src='{{ item.src }}' dest='{{ item.dest }}' group='{{ application_group }}'  mode=0640       
  loop:
     - { src: '{{ server_cert_file_name }}', dest: '{{ minio_home_cert }}/public.crt'  }
     - { src: '{{ server_key_file_name }}', dest: '{{ minio_home_cert}}/private.key'  }


# Task 5: Copy the CA certificate to the system's trusted certificates directory.
- name: copy  {{ ca_cert_file_name }} to /usr/local/share/ca-certificates/
  template: src='{{ item.src }}' dest='{{ item.dest }}'
  loop:
     - { src: '{{ ca_cert_file_name }}', dest: '/usr/local/share/ca-certificates/{{ ca_cert_file_name }}' }
   #notify: run certificates
  
# Task 6: Update the system's CA certificates by running the update-ca-certificates command.
- name:  run /usr/sbin/update-ca-certificates
  shell: /usr/sbin/update-ca-certificates --fresh

# Task 7: Add the CA certificate to the Java 17 truststore if not already present as rootCA.
- name: Add the {{ ca_cert_file_name }} to Java 17 truststore if not present as rootCA
  shell: |
    yes | {{ java_home_17 }}/bin/keytool  -delete  -alias rootCA  -cacerts  -storepass changeit
    yes | {{ java_home_17 }}/bin/keytool -importcert -trustcacerts \
      -alias rootCA \
      -file /usr/local/share/ca-certificates/{{ ca_cert_file_name }}\
      -keystore {{ java_home_17 }}/lib/security/cacerts \
      -storepass changeit
  ignore_errors: yes
    
# Task 8: Import the root CA certificate to the Java 24 truststore.    
- name: Import rootCA to Java 24 truststore
  shell: |
    yes | {{ java_home }}/bin/keytool  -delete  -alias rootCA  -cacerts  -storepass changeit
    yes | {{ java_home }}/bin/keytool -importcert -trustcacerts \
    -alias rootCA \
    -file /usr/local/share/ca-certificates/{{ ca_cert_file_name }} \
    -keystore {{ java_home }}/lib/security/cacerts \
    -storepass changeit \
    -noprompt
  ignore_errors: yes
    
# create java trust streo
- name: create java trust store
  shell: |
     rm -rf /etc/cert.d/javacert.*
     openssl pkcs12 -export -in {{ cert_dir }}/server.crt -inkey {{ cert_dir }}/server.key   -out {{ cert_dir }}/javacert.p12 -name javacert  -CAfile CA_cert.crt -caname root   -password pass:changeit
     {{ java_home_17 }}/bin/keytool -importkeystore -destkeystore {{ cert_dir }}/javacert.keystore.jks   -srckeystore {{ cert_dir }}/javacert.p12 -srcstoretype PKCS12   -alias javacert -deststorepass changeit -srcstorepass changeit
     {{ java_home_17 }}/bin/keytool -importcert -file /usr/local/share/ca-certificates/{{ ca_cert_file_name }}   -alias rootCA -keystore {{ cert_dir }}/javacert.truststore.jks -storepass changeit -noprompt
     chmod 640 {{ cert_dir }}/javacert.*
     chgrp application /etc/cert.d/javacert.*
  ignore_errors: yes

- name: Restart Keycloak service
  systemd:
     name: "{{ item }}" 
     state: restarted
     enabled: true
  loop:
     - keycloak.service
     - zookeeper.service    
  ignore_errors: true
