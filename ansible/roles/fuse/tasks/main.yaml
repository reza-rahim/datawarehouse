---
- name: modify /etc/fuse.conf
  lineinfile:
     dest: /etc/fuse.conf
     line: user_allow_other


- name: Create {{ fuse_home }}
  file:
    path: '{{ fuse_home }}'
    state: directory
    owner: '{{ fuse_user }}'
    group: '{{ fuse_group }}'


- name: check for '{{ spark_s3_application_dir }}'
  stat:
     path: '{{ spark_s3_application_dir }}'
  register: spark_dir_stat_result


- name: copy fuse scripts  
  template: src='{{ item.src }}' dest='{{ item.dest }}' group='{{ application_group }}' mode=0750
  loop:
     - { src: 'airflow_fuse.sh.j2', dest: '{{ fuse_home }}/airflow_fuse.sh'  }
     - { src: 'spark_fuse.sh.j2', dest: '{{ fuse_home }}/spark_fuse.sh'  }
     - { src: 'dbbackup_fuse.sh.j2', dest: '{{ fuse_home }}/dbbackup_fuse.sh'  }
     - { src: 'fuse.service.j2', dest: '/etc/systemd/system/fuse.service'  }
  notify:  restart start_fuse

- name: Create required directories with correct ownership
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ fuse_user }}"
    group: "{{ fuse_group }}"
    mode: '0775'
  loop:
    - "{{ spark_s3_logs_dir }}"
    - "{{ spark_s3_application_dir }}"
    - "{{ spark_s3_data_dir }}"
    - "{{ airflow_dag_dir }}"
    - "{{ airflow_log_dir }}"
    - '{{ pg_backup_dir }}'  
