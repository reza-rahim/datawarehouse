from keycloak_security_manager import OIDCSecurityManager
from flask_appbuilder.security.manager import AUTH_OID, AUTH_REMOTE_USER, AUTH_DB, AUTH_LDAP, AUTH_OAUTH
import logging
import os
from typing import Optional
from cachelib.file import FileSystemCache
from celery.schedules import crontab
import json
import os
import json
#---------------------------------------------------------
# Superset specific config
#---------------------------------------------------------
ROW_LIMIT = 5000
SUPERSET_WORKERS = 4

SUPERSET_WEBSERVER_PORT = {{ superset_port }}

SQLALCHEMY_DATABASE_URI='postgresql://postgres.{{ lookup('env', 'FQDN') }}:{{ postgresql_port }}/superset'
#
#---------------------------------------------------------

#---------------------------------------------------------
# Flask App Builder configuration
#---------------------------------------------------------
# Your App secret key
SECRET_KEY = os.environ['SUPERSET_SECRET_KEY'] 

# The SQLAlchemy connection string to your database backend
# This connection defines the path to the database that stores your
# superset metadata (slices, connections, tables, dashboards, ...).
# Note that the connection information to connect to the datasources
# you want to explore are managed directly in the web UI
#SQLALCHEMY_DATABASE_URI = 'sqlite:////to/superset.db'

# Flask-WTF flag for CSRF
CSRF_ENABLED = True

# Set this API key to enable Mapbox visualizations
MAPBOX_API_KEY = ''
WTF_CSRF_ENABLED = False 

AUTH_TYPE = AUTH_OID

KEYCLOAK_SUPERSET_CLIENT_SECRET = os.environ.get("KEYCLOAK_SUPERSET_CLIENT_SECRET")


OIDC_CLIENT_SECRETS = {
    "web": {
        "issuer": "https://keyclock.{{ fqdn }}:6443/realms/{{ keycloak_superset_realm }}",
        "auth_uri": "https://keyclock..com:6443/realms/{{ keycloak_superset_realm }}/protocol/openid-connect/auth",
        "client_id": "{{ keycloak_superset_client_id }}",
        "client_secret":  KEYCLOAK_SUPERSET_CLIENT_SECRET,
        "redirect_uris": [
            "https://keyclock.{{ fqdn }}:6443/*"
        ],
        "userinfo_uri": "'https://keyclock.{{ fqdn }}:6443/realms/{{ keycloak_superset_realm }}/protocol/openid-connect/userinfo",
        "token_uri": "https://keyclock.{{ fqdn }}:6443/realms/{{ keycloak_superset_realm }}/protocol/openid-connect/token",
        "token_introspection_uri": "https://keyclock.{{ fqdn }}:6443/realms/{{ keycloak_superset_realm }}/protocol/openid-connect/token/introspect"
    }
}

OIDC_COOKIE_SECURE = False
OIDC_CALLBACK_ROUTE = '/oauth2callback'
OIDC_SCOPES = ['openid', 'email', 'profile']
OIDC_INTROSPECTION_AUTH_METHOD = 'client_secret_post'

CUSTOM_SECURITY_MANAGER = OIDCSecurityManager

ENABLE_PROXY_FIX = True

